<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>事件检索</title>
		<link
			rel="shortcut icon"
			href="{{ url_for('static', filename='images/favicon.png') }}"
		/>
		<link
			rel="icon"
			href="{{ url_for('static', filename='images/favicon.png') }}"
		/>
		<link
			rel="stylesheet"
			href="https://unpkg.com/element-ui/lib/theme-chalk/index.css"
		/>
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		<script src="https://unpkg.com/element-ui/lib/index.js"></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

		<style>
			* {
				margin: 0;
				padding: 0;
			}

			a {
				text-decoration: none;
			}

			button {
				cursor: pointer;
			}

			.el-header {
				padding: 0;
			}
		</style>
	</head>
	<body>
		<div id="app">
			<el-container>
				<el-header>
					<el-menu
						:default-active="activeIndex"
						class="el-menu"
						mode="horizontal"
						@select="handleSelect"
						background-color="#343A40"
						text-color="#999C9F"
						active-text-color="#fff"
					>
						<el-menu-item index="1">
							<a href="/" id="brand">
								<img
									src="{{ url_for('static', filename='images/logo.svg') }}"
									alt="Logo"
								/>
								ASE Knowledge Graph
							</a></el-menu-item
						>
						<el-menu-item index="2"><a href="/">首页</a></el-menu-item>
						<el-menu-item index="3"
							><a href="/event_search">事件检索</a></el-menu-item
						>
						<el-menu-item index="4"><a href="/pattern">模式图</a></el-menu-item>
						<el-menu-item index="5"><a href="#">数据图</a></el-menu-item>
						<el-menu-item index="6"><a href="#">数据统计</a></el-menu-item>
						<el-menu-item index="7"><a href="#">帮助</a></el-menu-item>
					</el-menu></el-header
				>
				<el-container>
					<el-aside width="25%">
						<el-select
							@change="queryBasisChange()"
							v-model="queryBasisValue"
							clearable
							filterable
							default-first-option
							:loading="queryBasisLoading"
							:placeholder="queryBasisPlaceholder"
						>
							<el-option
								v-for="item in queryBasisOptions"
								:key="item"
								:label="item"
								:value="item"
							>
							</el-option>
						</el-select>
						<div>
							<el-input
								v-if="valueBoxType === 'search'"
								placeholder="search..."
								suffix-icon="el-icon-search"
								v-model="searchInputValue"
							>
							</el-input>
							<el-select
								v-else-if="valueBoxType === 'select'"
								v-model="specificChoiceValue"
								clearable
								filterable
								default-first-option
								:loading="specificChoiceLoading"
								:placeholder="specificChoicePlaceholder"
							>
								<el-option
									v-for="item in specificChoiceOptions"
									:key="item"
									:label="item"
									:value="item"
								>
								</el-option>
							</el-select>
							<el-date-picker
								v-else
								v-model="dateSelectValue"
								type="date"
								placeholder="选择日期"
								format="yyyy 年 MM 月 dd 日"
								value-format="yyyyMMdd"
							>
							</el-date-picker>
						</div>
						<el-button type="primary" plain @click="searchEventIntro()"
							>查询</el-button
						>
						<el-button
							type="info"
							icon="el-icon-plus"
							@click="dialogForAddVisible = true"
							plain
							circle
						></el-button>
					</el-aside>
					<el-main>
						<el-row :gutter="30">
							<el-col
								:span="8"
								v-for="event in eventsIntro"
								:key="event.事件名"
							>
								<el-card shadow="hover">
									<img :src="event.客机型号 | imgPath" />
									<div>
										{% raw %}
										<h2>
											{{ event.事件名 }}
										</h2>
										<el-row v-for="(value, key) in event">
											<div v-if="key != '事件名'">
												<el-col :span="12">{{ key + "：" }}</el-col>
												<el-col :span="12">{{ value }}</el-col>
											</div>
										</el-row>
										{% endraw %}
										<el-button
											type="danger"
											size="small"
											plain
											@click="deleteEvent(event)"
											>删除</el-button
										>
										<el-button
											type="primary"
											size="small"
											plain
											@click="showAndUpdateCardDetails(event.事件名)"
											>查看 / 修改</el-button
										>
									</div>
								</el-card>
							</el-col>
						</el-row>
						<el-pagination
							@current-change="pagerCurrentChange"
							:current-page.sync="currentPage"
							:page-size="pageSize"
							:page-count="pageCount"
							:pager-count="pagerCount"
							layout="prev, pager, next, jumper"
							hide-on-single-page
						>
						</el-pagination>
					</el-main>
				</el-container>
				<el-dialog
					:title="dialogForShowTitle"
					:visible.sync="dialogForShowVisible"
				>
					<el-table :data="dialogForShowData">
						<el-table-column
							property="key"
							label="属性"
							width="150"
						></el-table-column>
						<el-table-column property="value" label="值" width="200">
							<template slot-scope="scope">
								<el-input
									v-model="scope.row.value"
									v-if="scope.row.valueBoxIsInput"
								></el-input>
								{% raw %}
								<span v-else>{{ scope.row.value }}</span>
								{% endraw %}
							</template>
						</el-table-column>
						<el-table-column property="button" label="操作">
							<template slot-scope="scope">
								<el-button
									size="mini"
									circle
									:type="scope.row.button1Type"
									@click="dialogForShowButton1Clicked(scope.$index, scope.row)"
									:icon="scope.row.button1Icon"
								></el-button>
								<el-button
									v-if="scope.row.button == 2"
									size="mini"
									circle
									type="danger"
									@click="dialogForShowButton2Clicked(scope.$index, scope.row)"
									icon="el-icon-delete"
								></el-button>
							</template>
						</el-table-column>
					</el-table>
				</el-dialog>
				<el-dialog title="添加航空安全事件" :visible.sync="dialogForAddVisible">
					<el-table :data="dialogForAddData">
						<el-table-column
							property="key"
							label="属性"
							width="150"
						></el-table-column>
						<el-table-column property="value" label="值" width="200">
							<template slot-scope="scope">
								<el-input v-model="scope.row.value"></el-input>
							</template>
						</el-table-column>
					</el-table>
					<el-button type="primary" plain @click="addEvent()">提交</el-button>
				</el-dialog>
			</el-container>
		</div>
		<script>
			let vm = new Vue({
				el: "#app",
				data: {
					activeIndex: "3", // 当前活动页面（从 1 开始）

					/* queryBasis: 查询依据 */
					queryBasisLoading: true,
					queryBasisPlaceholder: "选择查询依据",
					queryBasisValue: "",
					queryBasisOptions: [],

					valueBoxType: "search",
					specificChoiceLoading: true,
					specificChoicePlaceholder: "",
					specificChoiceOptions: [],
					specificChoiceValue: "",
					dateSelectValue: "",
					searchInputValue: "",

					eventsIntro: [], // 事件简介

					/* 分页器 */
					currentPage: 1,
					pageSize: 15,
					pageCount: 0, // 页数
					pagerCount: 15, // 分页器的按钮个数
					pagerRequestUrl: "/all_events_intro?page=", // 分页器换页时向哪个 URL 发请求

					/* 用来展示和修改事件的弹出框 */
					dialogForShowTitle: "",
					dialogForShowVisible: false,
					dialogForShowData: [
						{
							key: "",
							value: "",
							button: 2, // 如果为 1，表示没有删除按钮
							button1Type: "primary",
							button1Icon: "el-icon-edit",
							valueBoxIsInput: false
						}
					],

					/* 用来添加事件的弹出框 */
					dialogForAddVisible: false,
					dialogForAddData: []
				},

				methods: {
					/* 添加一个事件 */
					addEvent() {
						let data = {};
						for (let i of this.dialogForAddData) data[i.key] = i.value;
						if (data.事件名.trim() === "") {
							this.$message.error("事件名不能为空！");
							return;
						}
						axios.post("/add_oneevent", data).then(rsp => {
							if (rsp.data["success"] == true) {
								this.$message.success("添加成功！");
								this.dialogForAddData = [];
							} else this.$message.error("添加失败！");
						});
					},

					/* 点击卡片上的 “删除” 按钮触发此方法 */
					deleteEvent(event) {
						axios
							.post("/del_oneevent", {
								事件名: event.事件名.slice(1, event.事件名.length)
							})
							.then(rsp => {
								if (rsp.data.success == true) {
									this.eventsIntro.splice(this.eventsIntro.indexOf(event), 1);
									this.$message.success("删除成功！");
								} else this.$message.error("删除失败！");
							});
					},

					/* 点击卡片上的 “查看 / 修改” 按钮触发此方法*/
					showAndUpdateCardDetails(eventName) {
						this.dialogForShowTitle = eventName;
						this.dialogForShowVisible = true;
						let data = {};
						axios
							.all([
								axios.get("/pattern_bottom"),
								axios.get("/event_info?event_name=" + eventName)
							])
							.then(
								axios.spread((rsp1, rsp2) => {
									for (let i of rsp1.data) data[i] = "";
									for (let i in rsp2.data) data[i] = rsp2.data[i];
									this.dialogForShowData = [];
									for (let i in data) {
										let row = {};
										row["key"] = i;
										row["value"] = data[i];
										if (data[i] === "事件名") row["button"] = 1;
										else row["button"] = 2;
										row["button1Type"] = "primary";
										row["button1Icon"] = "el-icon-edit";
										row["valueBoxIsInput"] = false;
										this.dialogForShowData.push(row);
									}
								})
							);
					},

					/* 点击 dialog 一行中的第一个 button 触发此方法 */
					dialogForShowButton1Clicked(index, row) {
						if (row.button1Type === "primary") {
							row.button1Type = "success";
							row.button1Icon = "el-icon-check";
							row.valueBoxIsInput = true;
						} else {
							row.button1Type = "primary";
							row.button1Icon = "el-icon-edit";
							row.valueBoxIsInput = false;
							axios
								.post("/update_attr", {
									name: this.dialogForShowTitle,
									key: row.key,
									value: row.value
								})
								.then(rsp => {
									if (rsp.data["success"] == true) {
										this.$message.success("修改成功！");
										this.dialogForShowData[index].value = row.value;
									} else this.$message.error("修改失败！");
								});
						}
					},

					/* 点击 dialog 一行中的删除按钮触发此方法 */
					dialogForShowButton2Clicked(index, row) {
						axios
							.post("/delete_attr", {
								name: this.dialogForShowTitle,
								key: row.key
							})
							.then(rsp => {
								if (rsp.data["success"] == true) {
									this.$message.success("删除成功！");
									this.dialogForShowData[index].value = "";
								} else this.$message.error("删除失败！");
							});
					},

					handleSelect(key, keyPath) {
						console.log(key, keyPath);
					},

					/* 查询依据改变时触发此方法 */
					queryBasisChange() {
						this.searchInputValue = this.specificChoiceValue = this.dateSelectValue =
							""; // 清空输入框的内容
						this.currentPage = 1; // 页面回到 1
						if (
							this.queryBasisValue === "原因" ||
							this.queryBasisValue === "结果"
						)
							this.valueBoxType = "search";
						else if (this.queryBasisValue === "时间")
							this.valueBoxType = "date";
						else {
							this.specificChoiceLoading = true;
							this.valueBoxType = "select";
							this.specificChoicePlaceholder = "选择" + this.queryBasisValue;
							axios.get("/all_detail?key=" + this.queryBasisValue).then(rsp => {
								this.specificChoiceOptions = rsp.data;
								this.specificChoiceLoading = false;
							});
						}
					},

					/* 点击 “查询” 按钮时触发此方法 */
					searchEventIntro() {
						let key = this.queryBasisValue;
						let value;
						if (this.valueBoxType === "search") value = this.searchInputValue;
						else if (this.valueBoxType === "date") value = this.dateSelectValue;
						else value = this.specificChoiceValue;
						this.pagerRequestUrl = `/events_intro?key=${key}&value=${value}&page=`;
						axios.get(this.pagerRequestUrl + "1").then(rsp => {
							this.pageCount = rsp.data.pop()["page_num"];
							this.eventsIntro = rsp.data;
						});
					},

					/* 页码变化时触发此方法 */
					pagerCurrentChange(val) {
						axios.get(this.pagerRequestUrl + val).then(rsp => {
							this.pageCount = rsp.data.pop()["page_num"];
							this.eventsIntro = rsp.data;
						});
					}
				},

				filters: {
					/* 将航班号过滤为图片路径 */
					imgPath(planeType) {
						return "/static/aircrafts/" + planeType.trim() + ".jpeg";
					}
				},

				mounted() {
					axios.get("/pattern_bottom").then(rsp => {
						let data = rsp.data;
						data.unshift("事件名");
						for (let i of data) {
							let row = {};
							row.key = i;
							row.value = "";
							this.dialogForAddData.push(row);
						}
						data.splice(data.indexOf("人员伤亡"), 1);
						this.queryBasisOptions = data;
						this.queryBasisLoading = false;
					});
					axios.get(this.pagerRequestUrl + "1").then(rsp => {
						this.pageCount = rsp.data.pop()["page_num"];
						this.eventsIntro = rsp.data;
					});
				}
			});
		</script>
	</body>
</html>
